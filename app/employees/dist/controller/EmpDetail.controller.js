sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/model/Filter","sap/m/MessageBox"],function(e,t,o,s,d){"use strict";return e.extend("employees.controller.EmpMaster",{onInit:function(){this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("RouteEmpDetail").attachPatternMatched(this._onRouteMatched,this);this.oGlobalBusyDialog=new sap.m.BusyDialog},_onRouteMatched:function(e){this.oGlobalBusyDialog.open();let o=e.getParameter("arguments").empId;this._empId=typeof o==="string"?parseInt(o):o;this.getView().getParent().getParent().setMode("HideMode");this.getView().setModel(new t({deleteEnabledAddress:false}),"oScreenMode");if(this._empId){this.handleViewBinding(o).then(()=>{let e=this.getView().getBindingContext(),o=e.getObject(),s=[],d=o.LINK_TO_EMP_PROJ.map(e=>e.PROJECT_ID),n=o.LINK_TO_EMP_TECH.map(e=>e.TECH_ID);o.LINK_TO_EMP_ADD.forEach(e=>{s.push({COUNTRY_ID:e.LINK_TO_COUNTRY?.COUNTRY_ID,COUNTRY_NAME:e.LINK_TO_COUNTRY?.COUNTRY_NAME,STATE_ID:e.LINK_TO_STATE?.STATE_ID,STATE_NAME:e.LINK_TO_STATE?.STATE_NAME,REGION:e.REGION,ADD_TYPE_ID:e.LINK_TO_ADD_TYPE?.ADD_TYPE_ID,ADD_TYPE:e.LINK_TO_ADD_TYPE?.ADD_TYPE,LOCATION_DETAILS:e.LOCATION_DETAILS})});this.oGlobalBusyDialog.close();this.getView().setModel(new t({Address:s,SEL_PROJECTS:d,SEL_TECHNOLOGIES:n}),"oEmpDetailModel")})}},handleViewBinding:function(e){return new Promise((t,o)=>{this.getView().bindElement({path:"/Employees("+e+")",parameters:{$expand:{LINK_TO_DEPARTMENT:{},LINK_TO_EMP_ADD:{$expand:{LINK_TO_COUNTRY:{},LINK_TO_STATE:{},LINK_TO_ADD_TYPE:{}},$select:"ID,LOCATION_DETAILS,REGION"},LINK_TO_EMP_PROJ:{$expand:{LINK_TO_PROJECTS:{}},$select:"PROJECT_ID"},LINK_TO_EMP_TECH:{$select:"ID,EMP_ID,TECH_ID",$expand:{LINK_TO_TECHNOLOGIES:{}}}},$select:"EMP_ID,FIRST_NAME,MIDDLE_NAME,LAST_NAME,PHONE,EMAIL,DATEOFBIRTH,CURRENCY,SALARY,DEPT_ID",$$updateGroupId:"empGroup"},events:{dataReceived:function(){t()}.bind(this)}})})},_createAddModel:function(){return new t({COUNTRY_ID:null,COUNTRY_NAME:null,STATE_ID:null,STATE_NAME:null,REGION:null,ADD_TYPE_ID:null,ADD_TYPE:null,LOCATION_DETAILS:null})},onCancelPress:function(){this.oRouter.navTo("RouteMaster");this.getView().getParent().getParent().setMode("ShowHideMode")},onAddTabSelChange:function(){var e=this.getView().byId("AddEmpTable");if(e.getSelectedItems().length!==0){this.getView().getModel("oScreenMode").setProperty("/deleteEnabledAddress",true)}else{this.getView().getModel("oScreenMode").setProperty("/deleteEnabledAddress",false)}},handleAddressTableUpdateFinished:function(e){let t=e.getParameter("total"),o=`Employee Address (${t})`;this.getView().byId("empAddressTableTitle").setText(o)},onDeleteAddress:function(){let e=this.getView().getModel("oEmpDetailModel"),t=e.getProperty("/Address"),o=this.getView().byId("AddEmpTable"),s=o.getSelectedItems(),n=this;if(s.length>0)d.confirm("Are you sure you want to delete selected items?",{onClose:function(d){if(d==="CANCEL"){return}let i=n._deleteAddress(s,t);n._executeAfterDeleteAddress(e,o,i)}})},_deleteAddress:function(e,t){var o=[];jQuery.each(e,function(t){o.push(e[t].sId.split("-")[e[t].sId.split("-").length-1])});o.forEach(function(e,o){if(o!==0){e=e-o}t.splice(e,1)});return t},_executeAfterDeleteAddress:function(e,t,o){e.setProperty("/Address",o);t.removeSelections(true);this.onAddTabSelChange()},onEmpAddressCreate:function(){let e=this._createAddModel();this.getView().setModel(e,"oCreateAddModel");o.load({name:"employees.view.AddressValueHelp",controller:this}).then(function e(t){this.addressFragment=t;this.getView().addDependent(this.addressFragment);t.open()}.bind(this))},onCancelAddress:function(){this.addressFragment.close();this.addressFragment.destroy()},onAddCountrySelChange:function(e){let t=e.getParameter("selectedItem").getKey(),o=sap.ui.getCore().byId("AddStateComboBox");if(t?.length>0){let e=[new s("COUNTRY_ID","EQ",t)];o.getBinding("items").filter(e)}},onAddressOkPress:function(){let e=this.getView().getModel("oEmpDetailModel"),t=this.getView().getModel("oCreateAddModel"),o=e.getProperty("/Address"),s=sap.ui.getCore().byId("AddTypeComboBox"),d=sap.ui.getCore().byId("AddStateComboBox"),n=sap.ui.getCore().byId("AddCountryComboBox");t.setProperty("/ADD_TYPE",s.getSelectedItem()?.getText());t.setProperty("/STATE_NAME",d.getSelectedItem()?.getText());t.setProperty("/COUNTRY_NAME",n.getSelectedItem()?.getText());o.push(t.getData());e.setProperty("/Address",o);this.onCancelAddress()},onSaveEmp:function(){var e=this.getView(),t=this;this.oGlobalBusyDialog.open();sap.ui.getCore().getMessageManager().removeAllMessages();this._saveEmpProjects();this._saveEmpTech();this._saveEmpAddress();e.getModel().submitBatch("empGroup").then(function(){t.oGlobalBusyDialog.close();d.success(`Employee ${t._empId} \n updated successfully`,{onClose:function(){e.getParent().getParent().setMode("ShowHideMode");t.oRouter.navTo("RouteMaster")}})}).catch(function(e){t.oGlobalBusyDialog.close();d.error(e.toString())})},_saveEmpProjects:function(){let e=this,t=e.getView(),o=t.getBindingContext(),s=t.getModel("oEmpDetailModel").getData(),d=s.SEL_PROJECTS,n=o.getObject().LINK_TO_EMP_PROJ.map(e=>e.PROJECT_ID),i=false,l=[];for(var r of d){if(!n.includes(r)){i=true;break}}if(n.length!==d.length){i=true}if(i){d.forEach(t=>{l.push({EMP_ID:e._empId,PROJECT_ID:t})});var a=t.getModel().bindContext("CatalogService.updateSelectedProjects(...)",o,{$$updateGroupId:"empGroup"});a.setParameter("selectedProjects",l);a.execute("empGroup").catch(function(e){console.log(e)})}},_saveEmpTech:function(){let e=this,t=e.getView(),o=t.getBindingContext(),s=t.getModel("oEmpDetailModel").getData(),d=s.SEL_TECHNOLOGIES,n=o.getObject().LINK_TO_EMP_TECH.map(e=>e.TECH_ID),i=false,l=[];for(var r of d){if(!n.includes(r)){i=true;break}}if(n.length!==d.length){i=true}if(i){d.forEach(t=>{l.push({EMP_ID:e._empId,TECH_ID:t})});var a=t.getModel().bindContext("CatalogService.updateSelectedTechnologies(...)",o,{$$updateGroupId:"empGroup"});a.setParameter("selectedTechnolgies",l);a.execute("empGroup").catch(function(e){console.log(e)})}},_saveEmpAddress:function(){let e=this,t=e.getView(),o=t.getBindingContext(),s=t.getModel("oEmpDetailModel").getData(),d=s.Address,n=[];d.forEach(t=>{n.push({EMP_EMP_ID:e._empId,COUNTRY_ID:t.COUNTRY_ID,STATE_ID:t.STATE_ID,REGION:t.REGION,LOCATION_DETAILS:t.LOCATION_DETAILS,ADD_TYPE_ID:t.ADD_TYPE_ID})});var i=t.getModel().bindContext("CatalogService.updateAddress(...)",o,{$$updateGroupId:"empGroup"});i.setParameter("aAddress",n);i.execute("empGroup").catch(function(e){console.log(e)})}})});